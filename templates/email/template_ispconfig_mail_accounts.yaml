zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: fd6ec9b2-4bda-4d65-9d8b-6c454aa5d010
      name: 'ISPConfig'
  templates:
    - uuid: 24f6648a-3b9a-4ac4-9d44-6361b9926bbb
      template: 'ISPConfig Email Accounts'
      name: 'ISPConfig Email Accounts Monitoring'
      description: |
        Template for monitoring ISPConfig email accounts
        
        This template discovers email accounts from ISPConfig and monitors:
        - Email account status (active/inactive)
        - Email address and domain
        - Mailbox quota and usage
        - Usage percentage
        - Spamfilter and antivirus status
        
        Requirements:
        - ISPConfig 3.2+ with SOAP API enabled
        - Zabbix Agent with UserParameter configured
        - PHP 7.4+ with SOAP extension
        - Email module enabled in configuration
        
        Author: ISPConfig Zabbix Monitoring Project
        Version: 1.0.0
      groups:
        - name: 'ISPConfig'
      discovery_rules:
        - uuid: 5e11a7cf-ab49-4f99-9814-46f744f78fcf
          name: 'ISPConfig Email Accounts Discovery'
          type: ZABBIX_ACTIVE
          key: 'ispconfig.emails.discovery'
          delay: 1h
          lifetime: 7d
          description: 'Discovers all email accounts configured in ISPConfig'
          item_prototypes:
            - uuid: a04b15e6-cf8a-4c34-aa54-c2913c1a5b90
              name: 'Email {#EMAIL}: Active Status'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.active[{#MAIL_USER_ID}]'
              delay: 5m
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              description: 'Active status of email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
                - tag: Email
                  value: '{#EMAIL}'
              
            - uuid: 8a64fe2f-3e84-4518-af2f-5f1fb21cd8eb
              name: 'Email {#EMAIL}: Email Address'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.email[{#MAIL_USER_ID}]'
              delay: 1h
              history: 7d
              trends: '0'
              value_type: CHAR
              description: 'Full email address'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
                - tag: Email
                  value: '{#EMAIL}'
              
            - uuid: 5669e98c-dbb5-4e4b-b7fe-ccdb5d734eb6
              name: 'Email {#EMAIL}: Domain'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.domain[{#MAIL_USER_ID}]'
              delay: 1h
              history: 7d
              trends: '0'
              value_type: CHAR
              description: 'Domain name of email'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
              
            - uuid: 28fa68e4-d727-4178-8380-468af19e6eed
              name: 'Email {#EMAIL}: Mailbox Usage'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.used[{#MAIL_USER_ID}]'
              delay: 10m
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              units: B
              description: 'Current mailbox usage for email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
              
            - uuid: c290788c-30ab-4834-9d46-f040a3a46561
              name: 'Email {#EMAIL}: Mailbox Quota'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.quota[{#MAIL_USER_ID}]'
              delay: 1h
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              units: B
              description: 'Mailbox quota for email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
              
            - uuid: d6e895f9-fa36-4aaa-8fe2-438abb5b4cea
              name: 'Email {#EMAIL}: Usage Percentage'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.usage_percent[{#MAIL_USER_ID}]'
              delay: 10m
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              units: '%'
              description: 'Mailbox usage percentage for email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
              
            - uuid: 05c7db66-32e3-4891-b5e0-32a872a4169f
              name: 'Email {#EMAIL}: Spamfilter Enabled'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.spamfilter_enabled[{#MAIL_USER_ID}]'
              delay: 1h
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              description: 'Spamfilter status for email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
              
            - uuid: 939711d7-533c-4c11-808b-4f4c03df1e89
              name: 'Email {#EMAIL}: Antivirus Enabled'
              type: ZABBIX_ACTIVE
              key: 'ispconfig.email.antivirus_enabled[{#MAIL_USER_ID}]'
              delay: 1h
              history: 30d
              trends: 90d
              value_type: UNSIGNED
              description: 'Antivirus status for email {#EMAIL}'
              tags:
                - tag: Application
                  value: 'ISPConfig Email'
          
          trigger_prototypes:
            - uuid: 3faec525-54ba-4d34-9b1a-79859a5636c8
              expression: 'last(/ISPConfig Email Accounts/ispconfig.email.active[{#MAIL_USER_ID}])=0'
              name: 'Email {#EMAIL} is inactive'
              priority: WARNING
              description: 'Email {#EMAIL} has been marked as inactive in ISPConfig'
              tags:
                - tag: Email
                  value: '{#EMAIL}'
              
            - uuid: 64fa1762-2a63-4890-8981-176777d1e93e
              expression: 'last(/ISPConfig Email Accounts/ispconfig.email.usage_percent[{#MAIL_USER_ID}])>90'
              name: 'Email {#EMAIL} mailbox usage high (>90%)'
              priority: WARNING
              description: 'Email {#EMAIL} is using more than 90% of its mailbox quota'
              manual_close: 'YES'
              tags:
                - tag: Email
                  value: '{#EMAIL}'
              
            - uuid: a334b730-1287-42c1-ba93-d11b1b79b84b
              expression: 'last(/ISPConfig Email Accounts/ispconfig.email.usage_percent[{#MAIL_USER_ID}])>=100'
              name: 'Email {#EMAIL} mailbox quota exceeded'
              priority: HIGH
              description: 'Email {#EMAIL} has exceeded its mailbox quota'
              manual_close: 'YES'
              dependencies:
                - name: 'Email {#EMAIL} mailbox usage high (>90%)'
              tags:
                - tag: Email
                  value: '{#EMAIL}'
          
          graph_prototypes:
            - uuid: 7c35e7fb-cc2a-4049-a5d2-342ebb675c19
              name: 'Email {#EMAIL}: Mailbox Usage'
              width: '900'
              height: '200'
              show_work_period: 'NO'
              show_triggers: 'YES'
              type: STACKED
              graph_items:
                - color: 1A7C11
      
      macros:
        - macro: '{$ISPCONFIG.EMAIL.WARN}'
          value: '90'
          description: 'Mailbox usage warning threshold (percentage)'
        
        - macro: '{$ISPCONFIG.EMAIL.CRIT}'
          value: '100'
          description: 'Mailbox usage critical threshold (percentage)'
