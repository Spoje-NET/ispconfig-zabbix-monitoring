#!/bin/sh
set -e

case "$1" in
    configure)
        # Create configuration directory
        mkdir -p /etc/ispconfig-zabbix-monitoring
        
        # Set proper permissions for scripts
        find /usr/share/ispconfig-zabbix-monitoring/autodiscovery/ -type f -name "*.php" -exec chmod +x {} \; 2>/dev/null || true
        find /usr/share/ispconfig-zabbix-monitoring/keys/ -type f -name "*.php" -exec chmod +x {} \; 2>/dev/null || true
        
        # Set proper ownership for library files
        chown -R root:root /usr/share/ispconfig-zabbix-monitoring/ 2>/dev/null || true
        chmod -R 644 /usr/share/ispconfig-zabbix-monitoring/lib/*.php 2>/dev/null || true
        chmod -R 644 /usr/share/ispconfig-zabbix-monitoring/templates/* 2>/dev/null || true
        
        # Restart zabbix-agent if running
        if systemctl is-active --quiet zabbix-agent >/dev/null 2>&1; then
            systemctl restart zabbix-agent || true
        fi
        
        # Restart zabbix-agent2 if running
        if systemctl is-active --quiet zabbix-agent2 >/dev/null 2>&1; then
            systemctl restart zabbix-agent2 || true
        fi
        
        echo "ISPConfig Zabbix monitoring installed successfully."
        echo "Configuration example: /usr/share/doc/ispconfig-zabbix-monitoring/examples/config.example.php"
        echo "Templates: /usr/share/ispconfig-zabbix-monitoring/templates/"
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0
