#!/bin/sh
set -e

case "$1" in
    configure)
        # Create configuration directory
        mkdir -p /etc/ispconfig-zabbix-monitoring
        
        # Get debconf values and create config.php file
        . /usr/share/debconf/confmodule
        
        db_get ispconfig-zabbix-monitoring/ispconfig_url
        ISPCONFIG_URL="$RET"
        
        db_get ispconfig-zabbix-monitoring/ispconfig_username
        ISPCONFIG_USERNAME="$RET"
        
        db_get ispconfig-zabbix-monitoring/ispconfig_password
        ISPCONFIG_PASSWORD="$RET"
        
        # Create or update config.php file only on first install or explicit reconfigure
        # - First install: /etc/ispconfig-zabbix-monitoring/config.php does not exist yet
        # - dpkg-reconfigure: DEBCONF_RECONFIGURE=1
        if [ ! -f /etc/ispconfig-zabbix-monitoring/config.php ] || [ "${DEBCONF_RECONFIGURE:-}" = "1" ]; then
            cat > /etc/ispconfig-zabbix-monitoring/config.php << 'EOF'
<?php
/**
 * ISPConfig Zabbix Monitoring Configuration
 * Generated during package installation or reconfiguration
 */

return [
    // ISPConfig SOAP API Configuration
    'soap_uri' => 'ISPCONFIG_URL_PLACEHOLDER',
    'soap_location' => 'ISPCONFIG_URL_PLACEHOLDER',
    'username' => 'ISPCONFIG_USERNAME_PLACEHOLDER',
    'password' => 'ISPCONFIG_PASSWORD_PLACEHOLDER',
    
    // SSL Verification (set to false for self-signed certificates)
    'verify_ssl' => false,
];
EOF
            # Replace placeholders with actual values
            sed -i "s|ISPCONFIG_URL_PLACEHOLDER|$ISPCONFIG_URL|g" /etc/ispconfig-zabbix-monitoring/config.php
            sed -i "s|ISPCONFIG_USERNAME_PLACEHOLDER|$ISPCONFIG_USERNAME|g" /etc/ispconfig-zabbix-monitoring/config.php
            sed -i "s|ISPCONFIG_PASSWORD_PLACEHOLDER|$ISPCONFIG_PASSWORD|g" /etc/ispconfig-zabbix-monitoring/config.php
        fi
        
        # Set proper ownership and permissions for config.php file if it exists
        if [ -f /etc/ispconfig-zabbix-monitoring/config.php ]; then
            chown root:zabbix /etc/ispconfig-zabbix-monitoring/config.php 2>/dev/null || chown root:root /etc/ispconfig-zabbix-monitoring/config.php
            chmod 640 /etc/ispconfig-zabbix-monitoring/config.php
        fi
        
        # Set proper permissions for scripts
        find /usr/share/ispconfig-zabbix-monitoring/autodiscovery/ -type f -name "*.php" -exec chmod +x {} \; 2>/dev/null || true
        find /usr/share/ispconfig-zabbix-monitoring/keys/ -type f -name "*.php" -exec chmod +x {} \; 2>/dev/null || true
        
        # Set proper ownership for library files
        chown -R root:root /usr/share/ispconfig-zabbix-monitoring/ 2>/dev/null || true
        chmod -R 644 /usr/share/ispconfig-zabbix-monitoring/lib/*.php 2>/dev/null || true
        chmod -R 644 /usr/share/ispconfig-zabbix-monitoring/templates/* 2>/dev/null || true
        
        # Install Zabbix agent configuration
        if [ -d /etc/zabbix/zabbix_agentd.d ]; then
            cp /usr/share/doc/ispconfig-zabbix-monitoring/examples/ispconfig-monitoring.conf /etc/zabbix/zabbix_agentd.d/
            chmod 644 /etc/zabbix/zabbix_agentd.d/ispconfig-monitoring.conf
            echo "Zabbix agent configuration installed to /etc/zabbix/zabbix_agentd.d/"
        fi
        
        if [ -d /etc/zabbix/zabbix_agent2.d ]; then
            cp /usr/share/doc/ispconfig-zabbix-monitoring/examples/ispconfig-monitoring.conf /etc/zabbix/zabbix_agent2.d/
            chmod 644 /etc/zabbix/zabbix_agent2.d/ispconfig-monitoring.conf
            echo "Zabbix agent2 configuration installed to /etc/zabbix/zabbix_agent2.d/"
        fi
        
        # Restart zabbix-agent if running
        if systemctl is-active --quiet zabbix-agent >/dev/null 2>&1; then
            systemctl restart zabbix-agent || true
        fi
        
        # Restart zabbix-agent2 if running
        if systemctl is-active --quiet zabbix-agent2 >/dev/null 2>&1; then
            systemctl restart zabbix-agent2 || true
        fi
        
        # Clear debconf database to avoid storing passwords
        db_purge
        
        echo "ISPConfig Zabbix monitoring installed successfully."
        echo "Configuration saved to /etc/ispconfig-zabbix-monitoring/config.php"
        echo "Templates: /usr/share/ispconfig-zabbix-monitoring/templates/"
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

composer-debian ispconfig-zabbix-monitoring

#DEBHELPER#

exit 0
